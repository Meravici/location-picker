<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-map/google-map.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <location-picker></location-picker>

Example:

    <location-picker>
      <h2>Hello location-picker</h2>
    </location-picker>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="location-picker">
    <template>
        <style>
            :host {
                display: block;
                box-sizing: border-box;
            }

            google-map {
                display: block;
                width: 100%;
                height: 100%;
            }
        </style>

        <google-map id="map" latitude="{{ latitude }}" longitude="{{ longitude }}" api-key="{{apiKey}}" click-events
                    drag-events on-google-map-click="clickHandler" on-google-map-zoom="zoomHandler"
                    disable-street-view-control>
            <google-map-marker id="marker" latitude="{{ latitude }}" longitude="{{ longitude }}" draggable="true"
                               title="Selected location"></google-map-marker>
        </google-map>
        <content></content>
    </template>

    <script>
        Polymer({
            is: 'location-picker',

            properties: {
                /**
                 * latitude of selected place
                 */
                latitude: {
                    type: Number,
                    notify: true,
                    value: 0
                },
                /**
                 * longitude of selected place
                 */
                longitude: {
                    type: Number,
                    notify: true,
                    value: 0
                },
                /**
                 * radius of selected place
                 */
                radius: {
                    type: Number,
                    notify: true
                }
            },

            // Element Lifecycle

            ready: function () {
                var that = this;
                this.map = this.$.map;
                this.marker = this.$.marker;
                this.map.addEventListener('google-map-ready', function (e) {
                    console.log('Map loaded!');
                    google.maps.event.addListener(that.map, 'zoom_changed', function () {
                        that.updateRadius();
                    });
                    google.maps.event.addListener(that.map, 'tilesloaded', function () {
                        that.updateRadius();
                    });
                });
            },

            // Element Behavior

            clickHandler: function (e, c) {
                this.marker.latitude = c.latLng.lat();
                this.marker.longitude = c.latLng.lng()
            },

            updateRadius: function (e, c) {
                var bounds = this.map.map.getBounds();
                var ne = bounds.getNorthEast(), sw = bounds.getSouthWest();
                return this.radius = this.distance(ne.lat(), ne.lng(), sw.lat(), sw.lng(), 'K');
            },

            distance: function (lat1, lon1, lat2, lon2, unit) {
                var radlat1 = Math.PI * lat1 / 180;
                var radlat2 = Math.PI * lat2 / 180;
                var theta = lon1 - lon2;
                var radtheta = Math.PI * theta / 180;
                var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
                dist = Math.acos(dist);
                dist = dist * 180 / Math.PI;
                dist = dist * 60 * 1.1515;
                if (unit == "K") {
                    dist = dist * 1.609344
                }
                if (unit == "N") {
                    dist = dist * 0.8684
                }
                return dist;
            }

        });
    </script>
</dom-module>
